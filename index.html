<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E-Absensi SMP IT Al Fathonah</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="E-Absensi">
    
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <style>
        :root {
            --primary: #2b59bc;
            --secondary: #ffcc00;
            --info: #00bcd4;
            --danger: #dc3545;
            --success: #28a745;
            --emerald: #10b981;
        }

        * { box-sizing: border-box; }
            
        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary);
            display: flex; justify-content: center;
            align-items: flex-start; 
            min-height: 100vh; color: white;
            overflow-x: hidden;
        }

        /* --- PERBAIKAN FONT GLOBAL UNTUK SEMUA INPUT --- */
        input, select, textarea, button {
            font-family: 'Segoe UI', Roboto, sans-serif !important;
        }

        #conn-status {
            position: fixed; top: 0; left: 0; width: 100%;
            padding: 8px; text-align: center; font-size: 12px;
            font-weight: bold; z-index: 10001; display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .online-bar { background: var(--success); color: white; }
        .offline-bar { background: var(--danger); color: white; }

        .container {
            width: 95%; max-width: 450px;
            padding: 10px 15px 30px; 
            text-align: center;
            animation: fadeInDown 1s ease-out;
            display: flex; flex-direction: column; align-items: center;
        }

        .logo { width: 42%; min-width: 120px; max-width: 180px; margin-bottom: 5px; transition: 0.3s; }
        
        h3 { margin: 5px 0 2px 0; font-weight: 800; letter-spacing: 1.2px; font-size: clamp(14px, 3.5vw, 16px); opacity: 1; }
        h2 { margin: 0 0 10px 0; font-size: clamp(17px, 5vw, 21px); font-weight: bold; line-height: 1.2; }

        .datetime-box { margin-bottom: 10px; width: 100%; }
        #date { font-size: clamp(13px, 3.5vw, 15px); font-weight: 500; margin-bottom: -1px; }
        #clock { font-size: clamp(22px, 6.5vw, 30px); font-weight: bold; color: var(--secondary); margin-top: 4px; line-height: 1.1; }

        .scanner-group {
            width: 100%;
            max-width: 340px; 
            margin: 1px auto 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .running-text-container {
            width: 100%;
            background: rgba(0, 0, 0, 0.6);
            overflow: hidden;
            padding: 4px 0;
            margin-bottom: -1px;
            border-radius: 20px 20px 0 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: block;
        }

        .marquee {
            white-space: nowrap;
            display: inline-block;
            animation: marquee 30s linear infinite; 
            will-change: transform;
        }

        .marquee span {
            font-size: 10px;
            color: #ffcc00;
            font-weight: bold;
            padding-right: 50px;
            display: inline-block;
        }

        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        #reader-wrapper {
            background: white; 
            padding: 10px;
            border-radius: 0 0 25px 25px;
            margin: 0 !important; 
            width: 100%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        #reader { width: 100%; border: none !important; border-radius: 18px; overflow: hidden; }
        
        .btn-switch {
            margin-top: 10px; background: #f4f4f4; border: 1px solid #ddd;
            color: #555; width: 45px; height: 45px; border-radius: 50%;
            font-size: 18px; cursor: pointer;
            transition: 0.3s; display: inline-flex; align-items: center; justify-content: center;
        }

        .instruction { font-weight: bold; margin: 12px 0; letter-spacing: 1.5px; font-size: 12px; text-transform: uppercase; }

        .button-group { display: flex; flex-direction: column; gap: 12px; align-items: center; width: 100%; }
        
        .btn-cek, .btn-admin, .btn-jadwal {
            border: none; padding: 14px 20px; border-radius: 14px;
            font-weight: bold; font-size: 14px; cursor: pointer;
            width: 100%; max-width: 320px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex; align-items: center; justify-content: center;
            gap: 12px; transition: 0.3s; color: white;
            text-decoration: none;
        }
        .btn-cek { background-color: var(--info); }
        .btn-jadwal { background-color: var(--emerald); }
        .btn-admin { background-color: var(--secondary); color: #333; }

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85);
            z-index: 9999; align-items: center; justify-content: center;
            backdrop-filter: blur(8px); padding: 10px;
        }

        .modal-box {
            background: white; color: #333; width: 100%;
            max-width: 350px; padding: 25px; border-radius: 25px;
            position: relative; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            text-align: center; max-height: 90vh; overflow-y: auto;
        }

        .modal-box h4 {
            margin: 0 0 15px 0; color: var(--primary);
            font-size: 19px; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px;
        }

        .close-modal { position: absolute; top: 18px; right: 20px; font-size: 24px; color: #bbb; cursor: pointer; }
        
        .input-group { margin-bottom: 12px; width: 100%; position: relative; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #f0f0f0;
            border-radius: 14px; font-size: 14px; outline: none; background: #fafafa;
        }

        .input-icon {
            position: absolute; right: 15px; top: 50%;
            transform: translateY(-50%); color: #bbb;
            font-size: 18px; cursor: pointer; z-index: 10;
        }

        .btn-submit {
            width: 100%; background: var(--primary); color: white;
            border: none; padding: 14px; border-radius: 14px;
            font-weight: bold; font-size: 15px; cursor: pointer; margin-bottom: 10px;
        }

        /* --- PENYELARASAN IKON DROPDOWN DAN KALENDER --- */
        #idGuruIzin, #statusIzin {
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%232b59bc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"></path></svg>');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 18px;
            padding-right: 45px;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%232b59bc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>') no-repeat;
            background-position: center;
            cursor: pointer;
            width: 20px;
            height: 20px;
        }

        .btn-logout {
            width: 100%; background: #fff5f5; color: var(--danger);
            border: 1px dashed var(--danger); padding: 10px; border-radius: 14px;
            font-weight: bold; cursor: pointer; font-size: 13px;
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px;
        }

        .dashboard-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .dash-item {
            padding: 10px; border-radius: 15px; color: white; text-align: center;
        }
        .dash-item span { display: block; font-size: 11px; text-transform: uppercase; font-weight: bold; }
        .dash-item b { font-size: 22px; }
        .bg-hadir { background: var(--success); }
        .bg-izin { background: #007bff; }
        .bg-sakit { background: #ffcc00; }
        .bg-alpha { background: var(--danger); }

        .divider { height: 2px; background: #f0f0f0; margin: 15px 0; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; font-size: 11px; color: #bbb; font-weight: bold; }

        #overlay {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); padding: 30px 20px;
            border-radius: 30px; z-index: 10000; width: 85%;
            max-width: 320px; text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }

        .profile-img {
            width: 110px; height: 110px; border-radius: 50%;
            border: 4px solid white; object-fit: cover;
            margin: 0 auto 15px; display: block; background: #eee;
        }

        .success { background: var(--success); color: white; }
        .error { background: var(--danger); color: white; }
        .loading { background: white; color: #333; }

        .footer-credit {
            margin-top: 30px;
            padding: 20px 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            letter-spacing: 0.5px;
        }
        .footer-credit b {
            color: var(--secondary);
            font-weight: 600;
        }
        .footer-credit i {
            color: #ff4d4d;
            font-size: 10px;
            margin: 0 2px;
        }
    </style>
</head>

<body>
    <div id="conn-status"></div>

    <div class="container">
        <img src="logo/Logo.png" alt="Logo" class="logo" onerror="this.src='https://via.placeholder.com/100?text=LOGO'">
        <h3>ABSENSI DIGITAL GURU & STAF</h3>
        <h2>SMP IT AL FATHONAH BABAKAN</h2>

        <div class="datetime-box">
            <div id="date">Memuat Tanggal...</div>
            <div id="clock">00:00:00</div>
        </div>

        <div class="scanner-group">
            <div class="running-text-container">
                <div class="marquee">
                    <span id="runningTextContent">Selamat Datang di Layanan Absensi Digital SMP IT Al Fathonah Babakan | Batas waktu scan mulai pukul 07:00 hingga 13:00 WIB | Hari Minggu dan hari libur nasional sistem absensi tidak aktif. Terima kasih.</span>
                </div>
            </div>

            <div id="reader-wrapper">
                <div id="reader"></div>
                <button class="btn-switch" onclick="switchCamera()">
                    <i class="fas fa-camera-rotate"></i>
                </button>
            </div>
        </div>

        <div class="instruction">Mohon Scan QR Code Anda</div>

        <div class="button-group">
            <button class="btn-cek" onclick="openModal('modalCek')"><i class="fas fa-search"></i> Cek Status Absensi</button>
            <button class="btn-jadwal" onclick="bukaJadwal()"><i class="fas fa-calendar-alt"></i> Lihat Jadwal Mapel</button>
            <button class="btn-admin" onclick="openModal('modalLogin')"><i class="fas fa-lock"></i> Login Admin</button>
        </div>

        <footer class="footer-credit animate__animated animate__fadeInUp">
            Developed with <i class="fas fa-heart"></i> by <b>Asep Fahmi Maulana</b>
            <div style="margin-top: 5px; opacity: 0.5; font-size: 10px;">© 2026 SMP IT Al Fathonah</div>
        </footer>
    </div>

<div id="modalCek" class="modal-overlay">
    <div class="modal-box animate__animated animate__zoomIn animate__faster">
        <span class="close-modal" onclick="closeModal('modalCek')">×</span>
        <h4>Intip Status Absen</h4>
        <div class="input-group">
            <input type="text" id="idCek" placeholder="Masukkan ID Guru Anda">
            <i class="fas fa-times-circle input-icon" onclick="clearInput('idCek')"></i>
        </div>
        <button class="btn-submit" id="btnProsesCek" onclick="prosesCekStatus()">Lihat Status</button>
        
        <div class="divider"><span>LUPA ID?</span></div>
        <button class="btn-cek" style="background-color: #6c757d; font-size: 12px; padding: 10px;" onclick="bukaDaftarID()">
            <i class="fas fa-users"></i> Cari ID Saya di Daftar Guru
        </button>
    </div>
</div>

<div id="modalDaftarID" class="modal-overlay">
    <div class="modal-box animate__animated animate__zoomIn animate__faster" style="max-width: 400px;">
        <span class="close-modal" onclick="closeModal('modalDaftarID')">×</span>
        <h4>Daftar ID Guru & Staf</h4>
        <div class="input-group">
            <input type="text" id="searchNamaGuru" placeholder="Ketik Nama Anda..." onkeyup="filterDaftarGuru()">
            <i class="fas fa-search input-icon"></i>
        </div>
        <div id="listGuruContainer" style="max-height: 300px; overflow-y: auto; text-align: left; margin-top: 10px; border: 1px solid #eee; border-radius: 10px;">
            </div>
    </div>
</div>

    <div id="modalLogin" class="modal-overlay">
        <div class="modal-box animate__animated animate__zoomIn animate__faster">
            <span class="close-modal" onclick="closeModal('modalLogin')">×</span>
            <h4>Login Admin</h4>
            <div class="input-group">
                <input type="text" id="userAdmin" placeholder="Username">
                <i class="fas fa-times-circle input-icon" onclick="clearInput('userAdmin')"></i>
            </div>
            <div class="input-group">
                <input type="password" id="passAdmin" placeholder="Password">
                <i class="fas fa-eye input-icon" id="togglePass" onclick="togglePassword('passAdmin', 'togglePass')"></i>
            </div>
            <button class="btn-submit" id="btnLogin" onclick="prosesLogin()">Login</button>
        </div>
    </div>

    <div id="modalIzin" class="modal-overlay">
        <div class="modal-box animate__animated animate__zoomIn animate__faster">
            <span class="close-modal" onclick="closeModal('modalIzin')">×</span>
            <h4>Panel Control Admin</h4>
            <div class="dashboard-grid">
                <div class="dash-item bg-hadir"><span>Hadir</span><b id="rekapHadir">0</b></div>
                <div class="dash-item bg-izin"><span>Izin</span><b id="rekapIzin">0</b></div>
                <div class="dash-item bg-sakit"><span>Sakit</span><b id="rekapSakit">0</b></div>
                <div class="dash-item bg-alpha"><span>Alpha</span><b id="rekapAlpha">0</b></div>
            </div>

            <div class="divider"><span>FITUR MONITORING & LAPORAN</span></div>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <button id="btnMonitor" onclick="monitorKehadiran()" style="flex: 1; background: #2196f3; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer;">
                    <i class="fas fa-desktop"></i> Monitor Live
                </button>
                <button id="btnExport" onclick="exportLaporan()" style="flex: 1; background: #059669; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; font-size: 12px; cursor: pointer;">
                    <i class="fas fa-file-excel"></i> Cetak Laporan
                </button>
            </div>

            <div id="areaHasilAdmin" style="display: none; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; font-size: 13px;">
            </div>
            
            <div class="divider"><span>INPUT IZIN / SAKIT</span></div>
            <div class="input-group">
                <select id="idGuruIzin">
                    <option value="">-- Pilih Nama Guru --</option>
                </select>
            </div>

            <div class="input-group">
                <select id="statusIzin">
                    <option value="I">Izin</option>
                    <option value="S">Sakit</option>
                </select>
            </div>

            <div class="input-group">
                <textarea id="ketIzin" placeholder="Tulis alasan izin/sakit di sini..." rows="2" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 14px; resize: none;"></textarea>
            </div>

            <button class="btn-submit" id="btnSimpanIzin" onclick="simpanIzin()">Simpan Data Izin</button>
            
            <div class="divider"><span>KELOLA HARI LIBUR</span></div>
            <div class="input-group">
                <input type="date" id="tglLibur" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; background-color: #f9f9f9; font-size: 14px; color: #333;">
            </div>
            <div class="input-group">
                <input type="text" id="ketLibur" placeholder="Keterangan Libur (Cth: Idul Fitri)" style="width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; background-color: #f9f9f9; font-size: 14px;">
            </div>
            <button class="btn-submit" style="background: #333; border-radius: 10px;" id="btnSimpanLibur" onclick="simpanLibur()">
                <i class="fas fa-calendar-plus"></i> Tambah Hari Libur
            </button>

            <div class="divider"><span>CETAK KODE</span></div>
            <button class="btn-submit" style="background: #10b981;" onclick="window.open(scriptURL + '?page=print', '_blank')">
                <i class="fas fa-qrcode"></i> GENERATE SEMUA KARTU QR
            </button>
            
            <button class="btn-logout" onclick="prosesLogout()"><i class="fas fa-sign-out-alt"></i> Logout Admin</button>
        </div>
    </div>

    <audio id="soundSuccess" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="soundError" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <div id="overlay"></div>

    <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzlVWGe41CqBXGCGncVk9DAXUE9X2shSrHLZY-AsClahBdIzvmYhZstG_CRyanCozDgKA/exec';
    let currentFacingMode = "environment";
    let isProcessing = false;
    const html5QrCode = new Html5Qrcode("reader");

    // --- FUNGSI UTILITAS ---

    function animateValue(id, start, end, duration) {
        if (start === end) {
            document.getElementById(id).innerText = end;
            return;
        }
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerText = Math.floor(progress * (end - start) + start);
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    function updateOnlineStatus() {
        const status = document.getElementById('conn-status');
        if (navigator.onLine) {
            status.innerText = "Koneksi Terhubung (Online)";
            status.className = "online-bar";
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        } else {
            status.innerText = "Koneksi Terputus (Offline)";
            status.className = "offline-bar";
            status.style.display = 'block';
        }
    }

    function updateTime() {
        const now = new Date();
        const options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        };
        document.getElementById('date').innerText = now.toLocaleDateString('id-ID', options);
        document.getElementById('clock').innerText = now.toLocaleTimeString('id-ID', {
            hour12: false
        });
    }
    setInterval(updateTime, 1000);
    updateTime();

    // --- MANAJEMEN MODAL & INPUT ---

    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        resetFormInputs(id);
    }

    function resetFormInputs(modalId) {
        const modal = document.getElementById(modalId);
        const inputs = modal.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            input.value = '';
            if (input.id === 'passAdmin') {
                input.type = 'password';
                document.getElementById('togglePass').className = 'fas fa-eye input-icon';
            }
        });
        const selects = modal.querySelectorAll('select');
        selects.forEach(select => select.selectedIndex = 0);
    }

    function clearInput(id) {
        document.getElementById(id).value = '';
        document.getElementById(id).focus();
    }

    function togglePassword(id, iconId) {
        const field = document.getElementById(id);
        const icon = document.getElementById(iconId);
        if (field.type === "password") {
            field.type = "text";
            icon.className = "fas fa-eye-slash input-icon";
        } else {
            field.type = "password";
            icon.className = "fas fa-eye input-icon";
        }
    }

    // --- KONTROL SCANNER ---
    function switchCamera() {
        currentFacingMode = (currentFacingMode === "environment") ? "user" : "environment";
        html5QrCode.stop().then(() => {
            startScanner();
        }).catch(err => console.error(err));
    }

    function startScanner() {
        html5QrCode.start({
                facingMode: currentFacingMode
            }, {
                fps: 15,
                qrbox: 250
            }, onScanSuccess)
            .catch(err => console.error(err));
    }

    // --- FITUR SUARA (AI) ---
    function bicara(teks) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel();

        const msg = new SpeechSynthesisUtterance();
        msg.text = teks;
        msg.lang = 'id-ID';

        let voices = window.speechSynthesis.getVoices();
        let selectedVoice = voices.find(v => v.name.includes('Google') && v.lang === 'id-ID') ||
            voices.find(v => v.lang === 'id-ID');

        if (selectedVoice) {
            msg.voice = selectedVoice;
        }

        msg.rate = 1.0;
        msg.pitch = 1.1;
        msg.volume = 1.0;

        window.speechSynthesis.speak(msg);
    }

    window.speechSynthesis.onvoiceschanged = () => {
        window.speechSynthesis.getVoices();
    };

    // --- LOGIKA UTAMA SCAN ---
    function onScanSuccess(decodedText) {
        const isModalOpen = document.querySelector('.modal-overlay[style*="display: flex"]');
        if (isModalOpen || isProcessing) return;

        isProcessing = true;
        html5QrCode.stop().then(() => {
            showStatus("⏳ Memproses...", "loading");
            const finalURL = `${scriptURL}?id=${encodeURIComponent(decodedText)}&t=${new Date().getTime()}`;

            fetch(finalURL)
                .then(response => response.text().then(text => {
                    try {
                        return {
                            type: 'json',
                            content: JSON.parse(text)
                        };
                    } catch (e) {
                        return {
                            type: 'text',
                            content: text
                        };
                    }
                }))
                .then(res => {
                    if (res.type === 'json') {
                        const data = res.content;

                        // --- 1. LOGIKA IDENTITAS & SAPAAN ---
                        let namaPanggilan = data.nama ? data.nama.split(',')[0] : "Bapak atau Ibu";
                        let sapaan = "";
                        if (data.gender === "L") {
                            sapaan = "Bapak ";
                        } else if (data.gender === "P") {
                            sapaan = "Ibu ";
                        } else {
                            sapaan = "Bapak atau Ibu ";
                        }

                        if (data.status === "success") {
                            // --- 2. LOGIKA SUARA BERHASIL ---
                            if (data.msg === "BERHASIL MASUK") {
                                document.getElementById('soundSuccess').play().catch(e => {});
                                bicara("Absen masuk berhasil. Selamat bertugas, " + sapaan + namaPanggilan);
                            } else if (data.msg === "BERHASIL PULANG") {
                                document.getElementById('soundSuccess').play().catch(e => {});
                                bicara("Absen pulang berhasil. Hati-hati di jalan " + sapaan + namaPanggilan + ", selamat beristirahat.");
                            }

                            // --- 3. TAMPILAN FOTO ---
                            let fileId = "";
                            if (data.foto && data.foto.includes("id=")) fileId = data.foto.split("id=")[1];
                            else if (data.foto && data.foto.includes("/d/")) fileId = data.foto.split("/d/")[1].split("/")[0];
                            let fotoUrl = fileId ? `https://drive.google.com/thumbnail?id=${fileId}&sz=w400` : "https://via.placeholder.com/100?text=FOTO";

                            let notifTerlambat = "";
                            if (data.terlambat && data.menit > 0) {
                                notifTerlambat = `<div class="animate__animated animate__shakeX" style="color: #ff3300; font-weight: 900; margin-top: 8px; background: white; border-radius: 8px; padding: 5px; font-size: 13px; border: 2px solid #ff3300;">⚠️ TERLAMBAT</div>`;
                            }

                            let htmlContent = `
                                <img src="${fotoUrl}" class="profile-img" onerror="this.src='https://via.placeholder.com/100?text=FOTO'">
                                <div style="font-size: 14px; margin-bottom: 5px; font-weight: 500;">${data.msg}</div>
                                <div style="font-size: 18px; font-weight: bold; color: yellow;">${data.nama}</div>
                                <div style="font-size: 13px; margin-top: 5px; background: rgba(0,0,0,0.2); display: inline-block; padding: 2px 10px; border-radius: 10px;">${data.jabatan}</div>
                                ${notifTerlambat}
                            `;
                            showStatus(htmlContent, "success", true);

                        } else {
                           // --- 4. LOGIKA SUARA DITOLAK (SESUAI PERMINTAAN) ---
playError();
if (data.msg.includes("BELUM DIBUKA") || data.msg.includes("SUDAH TUTUP") || data.msg.includes("WAKTU")) {
    // Notifikasi Suara untuk batasan jam 07:00 - 13:00
    bicara("Maaf " + sapaan + namaPanggilan + ", absensi hanya dibuka pukul 07:00 sampai 13:00 siang.");
} else if (data.msg.includes("COOLDOWN") || data.msg.includes("TUNGGU")) {
    // Notifikasi Suara untuk Cooldown (Scan beruntun)
    bicara("Mohon tunggu sebentar, " + sapaan + namaPanggilan + ". Anda baru saja melakukan scan.");
} else if (data.msg.includes("SUDAH LENGKAP")) {
    bicara("Maaf " + sapaan + namaPanggilan + ", absensi Anda sudah lengkap hari ini.");
} else if (data.msg.includes("jadwal") || data.msg.includes("DITOLAK")) {
    // Notifikasi Suara untuk tidak ada jadwal
    bicara("Maaf " + sapaan + namaPanggilan + ", Anda tidak dapat absen karena tidak memiliki jadwal hari ini.");
} else if (data.msg.includes("Minggu")) {
    // Notifikasi Suara khusus hari Minggu
    bicara("Maaf " + sapaan + namaPanggilan + ", hari Minggu absensi tidak aktif.");
} else {
    bicara("Maaf, permintaan absen ditolak.");
}
                            showStatus("⚠️ " + (data.msg || "Gagal"), "error");
                        }
                    } else {
                        playError();
                        showStatus(res.content, "error");
                    }
                })
                .catch((err) => {
                    playError();
                    showStatus("❌ Gagal Terhubung ke Server", "error");
                })
                .finally(() => setTimeout(() => {
                    document.getElementById('overlay').style.display = 'none';
                    isProcessing = false;
                    startScanner();
                }, 4000));
        });
    }

    function playError() {
        if (navigator.vibrate) navigator.vibrate([300, 150, 300]);
        document.getElementById('soundError').play().catch(e => {});
    }

    function showStatus(msg, type, isHTML = false) {
        const o = document.getElementById('overlay');
        if (isHTML) o.innerHTML = msg;
        else o.innerText = msg;
        o.className = type;
        o.style.display = 'block';
    }

// --- FITUR MONITOR & LAPORAN ADMIN ---
function monitorKehadiran() {
    const area = document.getElementById('areaHasilAdmin');
    const btn = document.getElementById('btnMonitor');
    
    // Logika Toggle (Buka-Tutup)
    if (area.style.display === "block" && area.innerHTML !== "") {
        area.style.display = "none";
        area.innerHTML = "";
        return;
    }

    area.style.display = "block";
    area.innerHTML = "<div style='text-align:center; padding:10px;'><i class='fas fa-spinner fa-spin'></i> Memproses data...</div>";
    btn.disabled = true;

    fetch(`${scriptURL}?action=getMonitor`)
        .then(res => res.json())
        .then(res => {
            if (res.status === "success") {
                // --- BAGIAN BELUM ABSEN (ALPHA / MERAH) ---
                let html = `<div style="margin-bottom:8px;"><strong>Belum Absen / Alpha (${res.belum.length}):</strong><br>`;
                if (res.belum.length === 0) html += `<span style="color:#64748b; font-style:italic;">Semua guru sudah absen.</span>`;
                res.belum.forEach(g => {
                    // Warna Merah untuk yang belum hadir sama sekali
                    html += `<span style="color:#ef4444; display:block; font-weight:500;">✘ ${g.nama}</span>`;
                });
                
                // --- BAGIAN SUDAH TERDATA (HADIR, IZIN, SAKIT) ---
                html += `</div><div style="border-top:1px solid #ddd; padding-top:8px;"><strong>Sudah Terdata (${res.sudah.length}):</strong><br>`;
                if (res.sudah.length === 0) html += `<span style="color:#64748b; font-style:italic;">Belum ada data masuk.</span>`;
                
                res.sudah.forEach(g => {
                    let warnaStatus = "#10b981"; // Default Hijau (Hadir)
                    let teksStatus = "Hadir";

                    if (g.status === "I") {
                        warnaStatus = "#2196f3"; // Biru (Izin)
                        teksStatus = "Izin";
                    } else if (g.status === "S") {
                        warnaStatus = "#f59e0b"; // Kuning/Oranye (Sakit)
                        teksStatus = "Sakit";
                    } else if (g.status === "A") {
                        warnaStatus = "#ef4444"; // Merah (Alpha - jika diinput manual)
                        teksStatus = "Alpha";
                    }

                    html += `<span style="color:${warnaStatus}; display:block; font-weight:500;">✔ ${g.nama} <small style="color:#64748b">(${g.jam} - ${teksStatus})</small></span>`;
                });
                area.innerHTML = html;
            }
        })
        .catch(() => { 
            area.innerHTML = "<div style='color:red;'>❌ Gagal memuat data.</div>"; 
        })
        .finally(() => { 
            btn.disabled = false; 
        });
}

    function exportLaporan() {
        const btn = document.getElementById('btnExport');
        const originalText = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Menyiapkan...";
        btn.disabled = true;

        fetch(`${scriptURL}?action=getLaporan`)
            .then(res => res.json())
            .then(res => {
                if (res.status === "success") {
                    let tableHtml = `<table border="1" style="border-collapse:collapse; width:100%; font-family:sans-serif; font-size:12px;">`;
                    res.data.forEach((row, idx) => {
                        tableHtml += `<tr style="${idx === 0 ? 'background:#eee; font-weight:bold;' : ''}">`;
                        row.forEach(cell => { tableHtml += `<td style="padding:5px;">${cell}</td>`; });
                        tableHtml += `</tr>`;
                    });
                    tableHtml += `</table>`;

                    const win = window.open("", "_blank");
                    win.document.write(`<html><head><title>Laporan Absensi ${res.bln}</title>`);
                    win.document.write(`<style>body{padding:20px; font-family:sans-serif;} table{width:100%; border-collapse:collapse;} td,th{padding:8px; border:1px solid #000;}</style>`);
                    win.document.write(`</head><body>`);
                    win.document.write(`<h3>Laporan Absensi SMP IT Al Fathonah - Bulan ${res.bln}</h3>`);
                    win.document.write(tableHtml);
                    win.document.write(`</body></html>`);
                    win.document.close();
                    win.print();
                }
            })
            .catch(() => alert("Gagal mengambil data laporan!"))
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }
        
    // --- PROSES ADMIN ---
function prosesLogin() {
    const u = document.getElementById('userAdmin').value;
    const p = document.getElementById('passAdmin').value;
    const btn = document.getElementById('btnLogin');

    if (!u || !p) {
        alert("Isi username dan password!");
        return;
    }

    btn.innerText = "Memverifikasi...";
    btn.disabled = true;

    // Mengirim permintaan login ke server (Code.gs)
    fetch(`${scriptURL}?action=loginAdmin&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                muatDropdownGuru();
                // Jika login berhasil, baru ambil data ringkasan
                btn.innerText = "Memuat Panel...";
                fetch(`${scriptURL}?action=getRingkasan`)
                    .then(res => res.json())
                    .then(dataRingkasan => {
                        closeModal('modalLogin');
                        openModal('modalIzin');
                        animateValue("rekapHadir", 0, dataRingkasan.hadir, 1200);
                        animateValue("rekapIzin", 0, dataRingkasan.izin, 1200);
                        animateValue("rekapSakit", 0, dataRingkasan.sakit, 1200);
                        animateValue("rekapAlpha", 0, dataRingkasan.alpha, 1200);
                    });
            } else {
                playError();
                alert("Username atau Password Salah!");
                btn.innerText = "Login";
                btn.disabled = false;
            }
        })
        .catch(() => {
            playError();
            alert("Gagal terhubung ke server!");
            btn.innerText = "Login";
            btn.disabled = false;
        });
}

    function prosesLogout() {
        document.getElementById('areaHasilAdmin').style.display = 'none';
document.getElementById('areaHasilAdmin').innerHTML = '';
        if (confirm("Keluar dari mode Admin?")) closeModal('modalIzin');
    }

        function muatDropdownGuru() {
    const dropdown = document.getElementById('idGuruIzin');
    
    // Ambil data dari server
    fetch(`${scriptURL}?action=getDaftarGuru`)
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                dropdown.innerHTML = '<option value="">-- Pilih Nama Guru --</option>';
                data.data.forEach(g => {
                    let option = document.createElement('option');
                    option.value = g.id;
                    option.text = g.nama; // Menampilkan Nama saja agar rapi
                    dropdown.appendChild(option);
                });
            }
        })
        .catch(err => console.error("Gagal muat daftar guru:", err));
}

   function simpanIzin() {
    const id = document.getElementById('idGuruIzin').value;
    const status = document.getElementById('statusIzin').value;
    const ket = document.getElementById('ketIzin').value;
    const btn = document.getElementById('btnSimpanIzin');

    if (!id || !ket) {
        alert("Lengkapi data!");
        return;
    }

    btn.disabled = true;
    btn.innerText = "Mengirim...";

    fetch(`${scriptURL}?action=tambahIzin&id=${id}&status=${status}&ket=${encodeURIComponent(ket)}`)
        .then(res => res.text())
        .then(data => {
            if (data.includes("⚠️") || data.includes("❌")) {
                playError();
                alert(data);
            } else {
                // Notifikasi sukses kecil (opsional, bisa pakai alert atau toast)
                alert("Data berhasil disimpan!");
                
                // --- PERBAIKAN UX ---
                // 1. Kosongkan inputan agar siap isi guru berikutnya
                document.getElementById('idGuruIzin').value = '';
                document.getElementById('ketIzin').value = '';
                document.getElementById('idGuruIzin').focus(); // Fokuskan kembali ke input ID

                // 2. Update angka dashboard (Rekap) secara otomatis
                // Agar admin melihat angka di atas langsung berubah
                fetch(`${scriptURL}?action=getRingkasan`)
                    .then(res => res.json())
                    .then(dataRingkasan => {
                        animateValue("rekapHadir", parseInt(document.getElementById('rekapHadir').innerText), dataRingkasan.hadir, 800);
                        animateValue("rekapIzin", parseInt(document.getElementById('rekapIzin').innerText), dataRingkasan.izin, 800);
                        animateValue("rekapSakit", parseInt(document.getElementById('rekapSakit').innerText), dataRingkasan.sakit, 800);
                        animateValue("rekapAlpha", parseInt(document.getElementById('rekapAlpha').innerText), dataRingkasan.alpha, 800);
                    });
            }
        })
        .catch(() => {
            playError();
            alert("Gagal mengirim data!");
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerText = "Simpan Izin";
        });
}

    function simpanLibur() {
        const tgl = document.getElementById('tglLibur').value;
        const ket = document.getElementById('ketLibur').value;
        const btn = document.getElementById('btnSimpanLibur');
        if (!tgl || !ket) {
            alert("Pilih tanggal dan isi keterangan!");
            return;
        }
        btn.disabled = true;
        btn.innerText = "Menyimpan...";
        fetch(`${scriptURL}?action=tambahLibur&tanggal=${tgl}&ket=${encodeURIComponent(ket)}`)
            .then(res => res.text())
            .then(data => {
                alert(data);
                document.getElementById('tglLibur').value = '';
                document.getElementById('ketLibur').value = '';
            })
            .catch(() => alert("Gagal menyimpan hari libur!"))
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "Tambah Hari Libur";
            });
    }

    function prosesCekStatus() {
        const id = document.getElementById('idCek').value;
        if (!id) return;
        const btn = document.getElementById('btnProsesCek');
        btn.disabled = true;
        btn.innerText = "Mengecek...";
        fetch(`${scriptURL}?action=cekStatus&id=${encodeURIComponent(id)}`)
            .then(res => res.text())
            .then(data => {
                alert(data);
                closeModal('modalCek');
            })
            .catch(() => {
                playError();
                alert("Gagal koneksi!");
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerText = "Lihat Status";
            });
    }

    function bukaDaftarID() {
        closeModal('modalCek');
        openModal('modalDaftarID');
        const container = document.getElementById('listGuruContainer');
        container.innerHTML = '<div style="padding: 20px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Mengambil data...</div>';

        fetch(`${scriptURL}?action=getDaftarGuru`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    let html = '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                    html += '<tr style="background: #f4f4f4; position: sticky; top: 0;"><th style="padding: 10px; text-align:left; border-bottom: 2px solid #ddd;">Nama</th><th style="padding: 10px; text-align:center; border-bottom: 2px solid #ddd;">ID</th></tr>';
                    data.data.forEach(g => {
                        html += `<tr class="item-guru">
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${g.nama}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee; font-weight: bold; color: #2b59bc; text-align:center;">${g.id}</td>
                                 </tr>`;
                    });
                    html += '</table>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="padding: 20px; color: red; text-align:center;">Gagal memuat data.</div>';
                }
            })
            .catch(() => {
                container.innerHTML = '<div style="padding: 20px; color: red; text-align:center;">Koneksi bermasalah.</div>';
            });
    }

    function filterDaftarGuru() {
        let input = document.getElementById('searchNamaGuru').value.toLowerCase();
        let rows = document.querySelectorAll('.item-guru');
        rows.forEach(row => {
            let nama = row.cells[0].innerText.toLowerCase();
            row.style.display = nama.includes(input) ? "" : "none";
        });
    }

    function bukaPrint() {
        window.open(scriptURL + "?page=print", "_blank");
    }

    function bukaJadwal() {
        const btn = document.querySelector('.btn-jadwal');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membuka...';
        btn.disabled = true;
        fetch(`${scriptURL}?action=getLinkJadwal`)
            .then(res => res.text())
            .then(link => {
                if (link && link.includes("http")) window.open(link, '_blank');
                else alert("Link jadwal belum diatur di Spreadsheet (Sel G2)!");
            })
            .catch(() => alert("Gagal mengambil link jadwal"))
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    window.onload = startScanner;
</script>
</body>
</html>












